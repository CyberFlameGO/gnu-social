#!/usr/bin/env sh

root="$(git rev-parse --show-toplevel)"

# get the list of changed files
staged_files="$(git status --porcelain | sed -rn "s/^[^ ][ ] (.*)/\1/p")"

if (! (: "${SKIP_ALL?}") 2>/dev/null) && (! (: "${SKIP_CS_FIX?}") 2>/dev/null); then
    echo "Running php-cs-fixer on edited files"
    for staged in ${staged_files}; do
        # work only with existing files
        if [ -f "${staged}" ] && expr "${staged}" : '^.*\.php$' > /dev/null;  then
            # use php-cs-fixer and get flag of correction
            if "${root}/bin/php-cs-fixer" -q --config="${root}/.php-cs-fixer.php" fix "${staged}"; then
                git add "${staged}" # execute git add directly
            fi
        fi
    done
fi

if (! (: "${SKIP_ALL?}") 2>/dev/null) && (! (: "${SKIP_DOC_CHECK?}") 2>/dev/null); then
    echo "Running php-doc-checker"
    if echo "${staged_files}" | grep -F ".php"; then
        "${root}/bin/php-doc-check" src plugins components
    fi
fi

if (! (: "${SKIP_ALL?}") 2>/dev/null) && (! (: "${SKIP_PHPSTAN?}") 2>/dev/null); then
    echo "Running phpstan"
    make phpstan
fi

# Only commit if there wasn't an error
exit $?
